# Nginx Configuration for Secure Admin Panel
# This configuration provides reverse proxy setup for the separated admin panel

# Rate limiting zone for admin endpoints
limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=10r/m;

# Main Application Server
server {
    listen 80;
    server_name yourdomain.com;
    
    root /path/to/frontend/dist;
    index index.html;
    
    # Main application routes
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Proxy API requests to backend
    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Block access to admin paths on main domain
    location ~ ^/(admin|secure-admin) {
        return 404;
    }
}

# Admin Panel Server (Hidden Path)
server {
    listen 80;
    server_name yourdomain.com;
    
    # Admin panel on non-guessable path
    location /secure-admin {
        alias /path/to/frontend/dist-admin;
        index index.admin.html;
        
        try_files $uri $uri/ /index.admin.html;
        
        # Security headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:8000;" always;
        
        # Rate limiting
        limit_req zone=admin_limit burst=5 nodelay;
        
        # Optional: IP whitelist (uncomment and configure)
        # allow 192.168.1.0/24;  # Your office network
        # allow 10.0.0.0/8;       # VPN network
        # deny all;
    }
    
    # Proxy admin API requests
    location /secure-admin/api {
        rewrite ^/secure-admin/api(.*)$ /api$1 break;
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cookie handling
        proxy_cookie_path /api /secure-admin/api;
    }
}

# Alternative: Admin Panel on Separate Subdomain (Recommended for Production)
server {
    listen 80;
    server_name admin.yourdomain.com;  # Change to your admin subdomain
    
    root /path/to/frontend/dist-admin;
    index index.admin.html;
    
    # All routes
    location / {
        try_files $uri $uri/ /index.admin.html;
        
        # Security headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:8000;" always;
    }
    
    # Proxy API requests
    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Rate limiting
    limit_req zone=admin_limit burst=5 nodelay;
    
    # Optional: IP whitelist (uncomment and configure)
    # allow 192.168.1.0/24;  # Your office network
    # allow 10.0.0.0/8;       # VPN network
    # deny all;
    
    # SSL Configuration (for HTTPS)
    # listen 443 ssl http2;
    # ssl_certificate /path/to/ssl/cert.pem;
    # ssl_certificate_key /path/to/ssl/key.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
}

# HTTPS Redirect (if using SSL)
# server {
#     listen 80;
#     server_name admin.yourdomain.com;
#     return 301 https://$server_name$request_uri;
# }

